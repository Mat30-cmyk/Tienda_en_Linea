<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Bajo Stock</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
</head>
<body class="bg-reportes">
    <nav class="navbar">
        <div class="logo">üõçÔ∏è Tienda Online</div>
        <ul class="nav-links">
            <li><a href="../index.html">Inicio</a></li>
            <li><a href="productos.html">Productos</a></li>
            <li><a href="compras.html">Compras</a></li>
            <li><a href="clientes.html">Clientes</a></li>
            <li><a href="reportes.html" class="active">Reporte</a></li>
        </ul>
    </nav>

    <div class="container d-flex justify-content-center align-items-start py-5">
        <div class="card-glass w-100 p-4 mt-5">
            <h2 class="mb-4 text-center">üö® Reporte de Bajo Stock</h2>

            <div class="text-center mb-3">
                <button id="btnReporte" class="btn btn-danger">Generar Reporte de Bajo Stock</button>
            </div>

            <div id="reporte" class="table-responsive">
                <p class="text-center text-muted">Presiona el bot√≥n para generar el informe.</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar la instancia de Supabase desde tu archivo de conexi√≥n
        import { supabase } from '../../supabase.js'; 

        if (!supabase) {
            console.error('Error: La conexi√≥n a Supabase no est√° inicializada.');
        }

        const btn = document.getElementById("btnReporte");
        const contenedor = document.getElementById("reporte");
        const UMBRAL_STOCK = 7; // Definimos el umbral de stock bajo

        /**
         * Funci√≥n principal para generar y mostrar el reporte de bajo stock.
         */
        btn.addEventListener("click", async () => {
            if (!supabase) {
                contenedor.innerHTML = "<p class='text-danger text-center'>Fallo de conexi√≥n a Supabase.</p>";
                return;
            }

            contenedor.innerHTML = "<p class='text-center'>‚è≥ Buscando productos con menos de " + UMBRAL_STOCK + " unidades...</p>";

            // 1. CONSULTA A LA TABLA 'productos' CON FILTRO (menor que 7)
            try {
                const { data, error } = await supabase
                    .from("productos")
                    // Filtra los productos donde 'stock_disponible' es menor que UMBRAL_STOCK (7)
                    .select("id, nombre, descripcion, stock_disponible")
                    .lt("stock_disponible", UMBRAL_STOCK) 
                    .order('stock_disponible', { ascending: true }); // Ordena del m√°s bajo al m√°s alto

                if (error) throw error;

                // 2. RENDERIZADO DEL REPORTE
                renderReporte(data);

            } catch (error) {
                contenedor.innerHTML = "<p class='text-danger text-center'>‚ùå Error cargando reporte: " + error.message + "</p>";
                console.error("Error en la consulta de bajo stock:", error);
            }
        });

        /**
         * Genera el HTML de la tabla para el reporte de bajo stock.
         */
        function renderReporte(productosBajoStock) {
            if (!productosBajoStock || productosBajoStock.length === 0) {
                contenedor.innerHTML = `<div class="alert alert-success text-center">
                                            ‚úÖ ¬°Buen trabajo! Todos los productos tienen ${UMBRAL_STOCK} o m√°s unidades.
                                        </div>`;
                return;
            }

            let html = `
                <h4 class="mt-4 text-danger text-center">Productos con Stock < ${UMBRAL_STOCK}</h4>
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-danger">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Descripci√≥n</th>
                            <th>Stock Actual</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            productosBajoStock.forEach(p => {
                html += `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.nombre}</td>
                        <td>${p.descripcion || 'Sin descripci√≥n'}</td>
                        <td class="fw-bold text-danger">${p.stock_disponible}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            contenedor.innerHTML = html;
        }

    </script>
</body>
</html>